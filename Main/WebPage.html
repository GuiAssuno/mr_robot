
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>testv5</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: Tahoma, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 5px;
            touch-action: manipulation;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 100%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 12px;
        }
        
        .header h1 {
            color: #333;
            font-size: 1.0rem;
            margin: 0;
        }
        
        .status {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            display: inline-block;
        }
        
        .status.error {
            background: #dc3545;
        }
        
        .status.blocked {
            background: #ffc107;
            color: #000;
        }
        
        .video-placeholder {
            background: #000;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            aspect-ratio: 4/3;
            margin: 5px 0;
            position: relative;
        }
        
        .video-desktop {
            background: #000;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
            aspect-ratio: 4/3;
            margin: 10px 0;
            position: relative;
            max-width: 320px;
            margin-right: auto;
            margin-left: auto;
        }

        .cameraStream {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 5px;
        }
        
        .video-status {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .mode-display {
            text-align: center;
            margin: 10px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .mode-text {
            font-size: 0.9rem;
            font-weight: bold;
            color: #495057;
        }
        
        .controls-section {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 5px;
            max-width: 160px;
            margin: 0 auto;
        }
        
        .side-controls {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
        }
        
        .control-btn { 
            width: 45px;
            height: 45px;
            border: 2px solid #333;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            transition: all 0.15s ease;
            background: #fff;
            color: #333;
        }

        .control-btn:active,
        .control-btn.active {
            transform: scale(0.9);
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .btn-mode {
            background: #e91e63;
            color: white;
            border-color: #c2185b;
        }
        
        .btn-stop {
            background: #4caf50;
            color: white;
            border-color: #388e3c;
        }
        
        .btn-up, .btn-down, .btn-left, .btn-right {
            background: #2196f3;
            color: white;
            border-color: #1976d2;
        }
        
        .btn-up {
            grid-column: 2;
            grid-row: 1;
        }
        
        .btn-left {
            grid-column: 1;
            grid-row: 2;
        }
        
        .btn-right {
            grid-column: 3;
            grid-row: 2;
        }
        
        .btn-down {
            grid-column: 2;
            grid-row: 2;
        }
        
        .control-label {
            text-align: center;
            font-weight: bold;
            color: #666;
            margin-top: 3px;
            font-size: 0.7rem;
        }

        /* =========== Joystick ===== */
        .joystick-container {
            position: relative;
            width: 90px;
            height: 90px;
            background: radial-gradient(circle, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #adb5bd;
            border-radius: 50%;
            margin: 10px auto;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: border-color 0.2s ease;
            touch-action: none;
        }
        
        .joystick-container.active {
            border-color: #e91e63;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1), 0 0 10px rgba(233, 30, 99, 0.2);
        }
        
        .joystick-knob {
            position: absolute;
            width: 35px;
            height: 35px;
            background: radial-gradient(circle, #e91e63 0%, #c2185b 100%);
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            touch-action: none;
        }
        
        .joystick-knob:active {
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        .joystick-label {
            text-align: center;
            margin-top: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 0.75rem;
        }
        
        /* Mobile Layouts */
        .landscape-layout,
        .portrait-layout {
            display: none;
        }
        
        /* Mobile Portrait */
        @media screen and (max-width: 768px) and (orientation: portrait) {
            .controls-section,
            .speed-section,
            .video-desktop {
                display: none;
            }
            
            .video-placeholder{
                max-width: none;
            }

            .portrait-layout {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            
            .portrait-buttons {
                display: flex;
                justify-content: space-around;
                gap: 15px;
                margin: 8px 0;
            }
            
            .portrait-controls {
                display: flex;
                justify-content: center;
            }
        }
        
        /* Mobile Landscape  */
        @media screen and (max-width: 900px) and (orientation: landscape) {
            .controls-section,
            .speed-section, 
            .video-desktop{
                display: none;
            }
            
            .landscape-layout {
                display: grid;
                grid-template-columns: 1fr 1.5fr 1fr;
                gap: 8px;
                align-items: center;
            }
            
            .landscape-controls {
                display: flex;
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            .container {
                max-width: 100%;
                height: auto;
                min-height: 95vh;
                border-radius: 0;
                padding: 8px;
            }
            
            .joystick-container {
                width: 80px;
                height: 80px;
                margin: 8px auto;
            }
            
            .joystick-knob {
                width: 30px;
                height: 30px;
            }
            
            .video-placeholder {
                max-height: 460px;
                margin: 5px 0;
            }
            
            .control-btn {
                width: 38px;
                height: 38px;
                font-size: 0.9rem;
            }
            
            .control-label {
                font-size: 0.65rem;
            }
            
            .header h1 {
                font-size: 1rem;
            }
            
            .mode-text {
                font-size: 0.8rem;
            }
        }
        
        /* Controles de Velocidade */
        .speed-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
        }
        
        .speed-display {
            margin-bottom: 8px;
        }
        
        .speed-label {
            font-weight: bold;
            color: #495057;
            margin-right: 8px;
            font-size: 0.9rem;
        }
        
        .speed-value {
            font-size: 1rem;
            font-weight: bold;
            color: #e91e63;
        }

        .btn-speed {
            background: #17a2b8;
            color: white;
            border-color: #138496;
            width: 40px;
            height: 40px;
            font-size: 1.1rem;
        }
        
        .debug-info {
            position: fixed;
            bottom: 8px;
            left: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">        
        <div class="mode-display">
            <div class="header">
                <h1>Controle ESP32</h1>
            </div>
            <div class="mode-text"><span id="modeText">Curva</span></div>
        </div>
        
        <!-- Desktop Layout -->
        <div class="video-desktop">
            <img id="cameraStreamDesktop" class="cameraStream" src='http://192.168.4.100:81/stream' alt="Stream da câmera" style="display: none;">
            <div id="videoStatusDesktop" class="video-status">Câmera...</div>
        </div>
        
        <!-- Controles de Velocidade -->
        <div class="speed-section">
            <div class="speed-display">
                <span class="speed-label">Velocidade:</span>
                <span id="speedValue" class="speed-value">70%</span>
            </div>
        </div>
        
        <div class="controls-section">
            <div class="side-controls">
                <button class="control-btn btn-mode" id="btnMode">M</button>
                <div class="control-label">MODO</div>
                
                <button class="control-btn btn-speed" id="btnSpeedUpAlt">⇧</button>
                <div class="control-label">ACELERAR</div>
            </div>

            <div class="controls-grid">
                <button class="control-btn btn-up" id="btnUp">↑</button>
                <button class="control-btn btn-left" id="btnLeft">←</button>
                <button class="control-btn btn-down" id="btnDown">↓</button>
                <button class="control-btn btn-right" id="btnRight">→</button>
            </div>
    
            <div class="side-controls">
                <button class="control-btn btn-stop" id="btnStop">X</button>
                <div class="control-label">DESBLOQ</div>
                
                <button class="control-btn btn-speed" id="btnSpeedDownAlt">⇩</button>
                <div class="control-label">REDUZIR</div>
            </div>
        </div>
        
        <!-- Mobile Portrait Layout -->
        <div class="portrait-layout">
            <div class="video-placeholder">
                <img id="cameraStreamPortrait" class="cameraStream" src='http://192.168.4.100:81/stream' alt="Stream da câmera" style="display: none;">
                <div id="videoStatusPortrait" class="video-status">Carregando câmera...</div>
            </div>
            
            <div class="portrait-buttons">
                <button class="control-btn btn-mode" id="btnModePortrait">M</button>
                <button class="control-btn btn-stop" id="btnStopPortrait">X</button>
            </div>
            
            <div class="portrait-controls">
                <div class="joystick-container" id="centerJoystick">
                    <div class="joystick-knob" id="centerKnob"></div>
                </div>
            </div>
        </div>
        
        <!-- Mobile Landscape Layout -->
        <div class="landscape-layout">
            <div class="landscape-controls">
                <button class="control-btn btn-mode" id="btnModeLandscape">M</button>
                
                <div class="joystick-container" id="leftJoystick">
                    <div class="joystick-knob" id="leftKnob"></div>
                    <div class="joystick-label">Frente/Ré</div>
                </div>
            </div>
            
            <div class="video-placeholder">
                <img id="cameraStreamLandscape" class="cameraStream" src='http://192.168.4.100:81/stream' alt="Stream da câmera" style="display: none;">
                <div id="videoStatusLandscape" class="video-status">Carregando câmera...</div>
            </div>
            
            <div class="landscape-controls">
                <button class="control-btn btn-stop" id="btnStopLandscape">X</button>
                
                <div class="joystick-container" id="rightJoystick">
                    <div class="joystick-knob" id="rightKnob"></div>
                    <div class="joystick-label">Esq/Dir</div>
                </div>
            </div>
        </div>
    </div>

    <div class="debug-info" id="debugInfo" style="display: none;"></div>

    <script>

        // Variável da conexão
        var connection;

        // Inicia a conexão assim que a página carrega
        function startWebSocket() {
          // Conecta no IP do Robô, porta 81
          connection = new WebSocket('ws://' + location.hostname + ':81/');
          
          connection.onopen = function () {
            console.log('WebSocket Conectado!');
          };
          
          connection.onerror = function (error) {
            console.log('WebSocket Error ', error);
          };

          // Se cair a conexão, tenta reconectar
          connection.onclose = function () {
            console.log('WebSocket Fechado. Reconectando...');
            setTimeout(startWebSocket, 2000);
          };
        }

        // Função nova de envio (Muito mais rápida)
        function cmd(c) {
          // Só envia se estiver conectado
          if (connection.readyState === WebSocket.OPEN) {
            connection.send(c); 
          }
        }

        // Inicia tudo
        startWebSocket();

        // Detectar Teclado (PC) - Continua igual, mas chama a nova função cmd()
        document.addEventListener('keydown', function(e) {
          if(e.repeat) return;
          if(e.key === "ArrowUp") cmd('F');
          if(e.key === "ArrowDown") cmd('B');
          if(e.key === "ArrowLeft") cmd('L');
          if(e.key === "ArrowRight") cmd('R');
          if(e.key === " ") cmd('S'); 
        });

        document.addEventListener('keyup', function(e) {
          cmd('S'); 
        });

        // ===== VARIÁVEIS GLOBAIS =====
        let currentMode = true;
        let isConnected = false;
        let currentSpeed = 70;
        let sendDelay = 100;
        let commandQueue = [];
        
        // Controle de joystick
        let leftJoystickData = { x: 0, y: 0 };
        let rightJoystickData = { x: 0, y: 0 };
        let centerJoystickData = { x: 0, y: 0 };
        
        // Histórico para filtro de suavização
        const valueHistory = {
            left: { values: [], maxHistory: 3 },
            right: { values: [], maxHistory: 3 },
            center: { values: [], maxHistory: 3 }
        };
        
        // Rastreamento de toques ativos por joystick
        const activeTouches = {
            left: null,
            right: null,
            center: null
        };
        
        // Threshold para evitar spam de comandos
        const COMMAND_THRESHOLD = 5;
        const SEND_DELAY = 100;

        // Controle de envio de comandos
        let isSending = false;
        let lastSendTime = 0;
        const SEND_INTERVAL = 50; // Intervalo mínimo entre envios (ms)

        // Estado de controle de teclado
        const pressedKeys = new Set();

        const buttonElements = {
            mode: ['btnMode', 'btnModePortrait', 'btnModeLandscape'],
            stop: ['btnStop', 'btnStopPortrait', 'btnStopLandscape'],
            up: ['btnUp'],
            down: ['btnDown'],
            left: ['btnLeft'],
            right: ['btnRight'],
            speedUp: ['btnSpeedUp', 'btnSpeedUpAlt'],
            speedDown: ['btnSpeedDown', 'btnSpeedDownAlt']
        };

        // Mapeamento de comandos
        const keyMapping = {
            'ArrowUp': { press: 'F', release: 'F', buttons: ['btnUp'] },
            'ArrowDown': { press: 'B', release: 'B', buttons: ['btnDown'] },
            'ArrowLeft': { press: 'L', release: 'L', buttons: ['btnLeft'] },
            'ArrowRight': { press: 'R', release: 'R', buttons: ['btnRight'] },
            'KeyA': { press: 'A', release: null, buttons: buttonElements.mode },
            'KeyS': { press: 'X', release: null, buttons: buttonElements.stop },
            'ShiftLeft': { press: '+', release: null, buttons: buttonElements.speedUp },
            'ShiftRight': { press: '+', release: null, buttons: buttonElements.speedUp },
            'ControlLeft': { press: '-', release: null, buttons: buttonElements.speedDown },
            'ControlRight': { press: '-', release: null, buttons: buttonElements.speedDown }
        };
        
        // ===== SISTEMA DE ENVIO DE COMANDOS =====
        function processCommandQueue() {
            if (commandQueue.length > 0 && !isSending) {
                isSending = true;
                const commandToSend = commandQueue.shift();
                
                fetch('/command?cmd=' + commandToSend)
                    .then(response => response.text())
                    .then(data => {
                        console.log(`Comando enviado: ${commandToSend} - Resposta: ${data}`);
                        updateConnectionStatus(data);
                    })
                    .catch(error => {
                        console.error(`Erro ao enviar comando ${commandToSend}:`, error);
                        updateConnectionStatus('ERROR');
                    })
                    .finally(() => {
                        setTimeout(() => {
                            isSending = false;
                            processCommandQueue();
                        }, sendDelay);
                    });
            }
        }
        
        function sendCommand(cmd) {
            commandQueue.push(cmd);
            processCommandQueue();
        }
        
        // ===== CONTROLES DE TECLADO =====
        function handleKeyDown(e) {
            if (e.repeat) return;
            
            const mapping = keyMapping[e.code];
            if (mapping && !pressedKeys.has(e.code)) {
                e.preventDefault();
                pressedKeys.add(e.code);
                
                // Ativar feedback visual
                mapping.buttons.forEach(buttonId => {
                    const btn = document.getElementById(buttonId);
                    if (btn) btn.classList.add('active');
                });
                
                // Enviar comando
                sendCommand(mapping.press);
                
                // Ações especiais
                if (e.code === 'KeyA') {
                    toggleMode();
                } else if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') {
                    increaseSpeed();
                } else if (e.code === 'ControlLeft' || e.code === 'ControlRight') {
                    decreaseSpeed();
                }
                
                console.log(`Tecla pressionada: ${e.code} -> ${mapping.press}`);
            }
        }
        
        function handleKeyUp(e) {
            const mapping = keyMapping[e.code];
            if (mapping && pressedKeys.has(e.code)) {
                e.preventDefault();
                pressedKeys.delete(e.code);
                
                // Remover feedback visual
                mapping.buttons.forEach(buttonId => {
                    const btn = document.getElementById(buttonId);
                    if (btn) btn.classList.remove('active');
                });
                
                // Enviar comando de release se existir
                if (mapping.release) {
                    sendCommand(mapping.release);
                }
                
                console.log(`Tecla solta: ${e.code} -> ${mapping.release || 'null'}`);
            }
        }

           
        // Prevenir eventos de scroll e zoom
        //    container.addEventListener('touchmove', function(e) {
        //      if (isDragging) e.preventDefault();
        // }, { passive: false });
        

        // ===== CONTROLES DE BOTÃO =====
        function setupButtonEvents() {
            // Botões de modo (M)
            buttonElements.mode.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    setupButtonEvent(button, 'A', null, true, false);
                }
            });
            
            // Botões de parada/desbloqueio (X)
            buttonElements.stop.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    setupButtonEvent(button, 'X', null, false, false);
                }
            });
            
            // Botões de velocidade
            buttonElements.speedUp.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    setupButtonEvent(button, '+', null, false, true);
                }
            });
            
            buttonElements.speedDown.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    setupButtonEvent(button, '-', null, false, true);
                }
            });
            
            // Botões direcionais (apenas desktop)
            if (document.getElementById('btnUp')) {
                setupButtonEvent(document.getElementById('btnUp'), 'F', 'S', false, false);
            }
            if (document.getElementById('btnDown')) {
                setupButtonEvent(document.getElementById('btnDown'), 'B', 'S', false, false);
            }
            if (document.getElementById('btnLeft')) {
                setupButtonEvent(document.getElementById('btnLeft'), 'L', 'E', false, false);
            }
            if (document.getElementById('btnRight')) {
                setupButtonEvent(document.getElementById('btnRight'), 'R', 'D', false, false);
            }
        }
        
        function setupButtonEvent(button, pressCmd, releaseCmd, toggleModeFlag, speedControl) {
            let isPressed = false;
            
            function pressHandler(e) {
                if (isPressed) return;
                isPressed = true;
                e.preventDefault();
                
                button.classList.add('active');
                sendCommand(pressCmd);
                
                if (toggleModeFlag) {
                    toggleMode();
                } else if (speedControl) {
                    if (pressCmd === '+') {
                        increaseSpeed();
                    } else if (pressCmd === '-') {
                        decreaseSpeed();
                    }
                }
                
                console.log(`Botão pressionado: ${pressCmd}`);
            }
            
            function releaseHandler(e) {
                if (!isPressed) return;
                isPressed = false;
                e.preventDefault();
                
                button.classList.remove('active');
                
                if (releaseCmd) {
                    sendCommand(releaseCmd);
                    console.log(`Botão solto: ${releaseCmd}`);
                }
            }
            
            // Mouse events
            button.addEventListener('mousedown', pressHandler);
            button.addEventListener('mouseup', releaseHandler);
            button.addEventListener('mouseleave', releaseHandler);
            
            // Touch events
            button.addEventListener('touchstart', pressHandler, { passive: false });
            button.addEventListener('touchend', releaseHandler);
            button.addEventListener('touchcancel', releaseHandler);
        }
        
        // ===== CONTROLES DE VELOCIDADE =====
        function increaseSpeed() {
            currentSpeed = Math.min(currentSpeed + 10, 100);
            updateSpeedDisplay();
            console.log(`Velocidade aumentada para: ${currentSpeed}%`);
        }
        
        function decreaseSpeed() {
            currentSpeed = Math.max(currentSpeed - 10, 20);
            updateSpeedDisplay();
            console.log(`Velocidade reduzida para: ${currentSpeed}%`);
        }
        
        function updateSpeedDisplay() {
            const speedValue = document.getElementById('speedValue');
            
            if (speedValue) {
                speedValue.textContent = currentSpeed + '%';
            }
        }
        
        // ===== STREAM DE VÍDEO =====
        function setupCameraStream() {
            const streams = [
                { element: 'cameraStreamDesktop', status: 'videoStatusDesktop' },
                { element: 'cameraStreamPortrait', status: 'videoStatusPortrait' },
                { element: 'cameraStreamLandscape', status: 'videoStatusLandscape' }
            ];
            
            streams.forEach(stream => {
                const streamElement = document.getElementById(stream.element);
                const statusElement = document.getElementById(stream.status);
                
                if (streamElement && statusElement) {
                    streamElement.onload = () => {
                        streamElement.style.display = 'block';
                        statusElement.style.display = 'none';
                    };
                    
                    streamElement.onerror = () => {
                        streamElement.style.display = 'none';
                        statusElement.style.display = 'block';
                        statusElement.textContent = 'Câmera indisponível';
                        
                        // Tentar reconectar após 3 segundos
                        setTimeout(() => {
                            statusElement.textContent = 'Reconectando...';
                            streamElement.src = `http://192.168.4.100:81/stream?t=${Date.now()}`;
                        }, 3000);
                    };
                    
                    // Iniciar stream
                    streamElement.src = 'http://192.168.4.100:81/stream';
                }
            });
        }
        
        // ===== CONTROLES DE INTERFACE =====
        function toggleMode() {
            currentMode = !currentMode;
            const modeText = currentMode ? 'Curva' : 'Gira';
            
            const modeDisplay = document.getElementById('modeText');
            if (modeDisplay) {
                modeDisplay.textContent = modeText;
            }
            
            console.log(`Modo alterado para: ${modeText}`);
        }

        // ===== FILTRO DE SUAVIZAÇÃO =====
        function smoothValue(type, axis, newValue) {
            if (!valueHistory[type].values.length) {
                valueHistory[type].values = Array(valueHistory[type].maxHistory).fill({ x: 0, y: 0 });
            }
            
            // Adicionar novo valor ao histórico
            valueHistory[type].values.push({ 
                x: axis === 'x' ? newValue : valueHistory[type].values[valueHistory[type].values.length - 1].x,
                y: axis === 'y' ? newValue : valueHistory[type].values[valueHistory[type].values.length - 1].y
            });
            
            // Manter apenas o histórico mais recente
            if (valueHistory[type].values.length > valueHistory[type].maxHistory) {
                valueHistory[type].values.shift();
            }
            
            // Calcular média dos valores históricos
            let sumX = 0;
            let sumY = 0;
            
            for (const value of valueHistory[type].values) {
                sumX += value.x;
                sumY += value.y;
            }
            
            const avgX = Math.round(sumX / valueHistory[type].values.length);
            const avgY = Math.round(sumY / valueHistory[type].values.length);
            
            return axis === 'x' ? avgX : avgY;
        }

        // ===== SISTEMA DE ENVIO DE COMANDOS OTIMIZADO =====
        function sendCommand(cmd) {
            fetch('/command?cmd=' + cmd)
                .then(response => response.text())
                .then(data => {
                    updateConnectionStatus(data);
                })
                .catch(error => {
                    console.error(`Erro ao enviar comando ${cmd}:`, error);
                    updateConnectionStatus('ERROR');
                });
        }

        // ===== CONTROLES DE JOYSTICK - IMPLEMENTAÇÃO CORRIGIDA =====
        function setupJoysticks() {
            const joysticks = [
                { container: 'leftJoystick', knob: 'leftKnob', type: 'left' },
                { container: 'rightJoystick', knob: 'rightKnob', type: 'right' },
                { container: 'centerJoystick', knob: 'centerKnob', type: 'center' }
            ];

            joysticks.forEach(joystick => {
                const container = document.getElementById(joystick.container);
                const knob = document.getElementById(joystick.knob);
                
                if (container && knob) {
                    // Limpar event listeners existentes
                    const newKnob = knob.cloneNode(true);
                    knob.parentNode.replaceChild(newKnob, knob);
                    
                    // Configurar novos event listeners
                    setupJoystickEvents(container, newKnob, joystick.type);
                }
            });
        }

        function setupJoystickEvents(container, knob, type) {
            let isDragging = false;
            let rect, centerX, centerY, maxRadius;
            let touchId = null;

            const startDrag = (e) => {
                // Para eventos de touch, prevenir o comportamento padrão
                if (e.type === 'touchstart') {
                    e.preventDefault();
                }
                
                isDragging = true;
                
                // Para touch events, capturar o identificador do toque
                if (e.type === 'touchstart') {
                    touchId = e.changedTouches[0].identifier;
                    activeTouches[type] = touchId;
                } else {
                    touchId = 'mouse';
                }
                
                rect = container.getBoundingClientRect();
                centerX = rect.width / 2;
                centerY = rect.height / 2;
                maxRadius = (rect.width / 2) - 15;
                
                // Feedback visual
                container.classList.add('active');
                knob.style.transition = 'none';
                
                // Processar a posição inicial
                processDrag(e);
            };

            const processDrag = (e) => {
                if (!isDragging) return;
                
                let clientX, clientY;
                
                // Obter coordenadas baseadas no tipo de evento
                if (e.type === 'mousemove') {
                    clientX = e.clientX;
                    clientY = e.clientY;
                } else if (e.type === 'touchmove') {
                    // Encontrar o toque correto para este joystick
                    let correctTouch = null;
                    for (let i = 0; i < e.touches.length; i++) {
                        if (e.touches[i].identifier === touchId) {
                            correctTouch = e.touches[i];
                            break;
                        }
                    }
                    
                    if (!correctTouch) {
                        endDrag(e);
                        return;
                    }
                    
                    clientX = correctTouch.clientX;
                    clientY = correctTouch.clientY;
                    e.preventDefault();
                } else {
                    return;
                }

                let x = clientX - rect.left - centerX;
                let y = clientY - rect.top - centerY;
                
                // Limitar movimento baseado no tipo de joystick
                if (type === 'left') {
                    x = 0; // Apenas movimento vertical para joystick esquerdo
                } else if (type === 'right') {
                    y = 0; // Apenas movimento horizontal para joystick direito
                }
                
                // Limitar ao círculo
                const distance = Math.sqrt(x * x + y * y);
                if (distance > maxRadius) {
                    x = (x / distance) * maxRadius;
                    y = (y / distance) * maxRadius;
                }
                
                // Posicionar o knob
                knob.style.left = (centerX + x) + 'px';
                knob.style.top = (centerY + y) + 'px';
                
                // Converter para valores de comando (-100 a +100)
                const cmdX = Math.round((x / maxRadius) * 100);
                const cmdY = Math.round((-y / maxRadius) * 100); // Inverter Y
                
                updateJoystickCommand(cmdX, cmdY, type);
            };

            const endDrag = (e) => {
                // Verificar se este é realmente o toque que iniciou o arrasto
                if (e.type === 'touchend' || e.type === 'touchcancel') {
                    let isOurTouch = false;
                    
                    // Verificar se o toque que terminou é o deste joystick
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        if (e.changedTouches[i].identifier === touchId) {
                            isOurTouch = true;
                            break;
                        }
                    }
                    
                    if (!isOurTouch) return;
                }
                
                if (!isDragging) return;
                isDragging = false;
                activeTouches[type] = null;
                
                // Remover feedback visual
                container.classList.remove('active');
                
                // Retornar knob ao centro com transição
                knob.style.transition = 'all 0.2s ease';
                knob.style.left = '50%';
                knob.style.top = '50%';
                
                // Resetar os valores do joystick específico
                if (type === 'left') {
                    leftJoystickData = { x: 0, y: 0 };
                    valueHistory.left.values = [];
                } else if (type === 'right') {
                    rightJoystickData = { x: 0, y: 0 };
                    valueHistory.right.values = [];
                } else {
                    centerJoystickData = { x: 0, y: 0 };
                    valueHistory.center.values = [];
                }
                
                // Enviar comando de parada imediatamente
                sendJoystickCommand(true);
            };

            // Event listeners para mouse
            knob.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', processDrag);
            document.addEventListener('mouseup', endDrag);
            
            // Event listeners para touch
            knob.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', processDrag, { passive: false });
            document.addEventListener('touchend', endDrag);
            document.addEventListener('touchcancel', endDrag);
            
            // Prevenir eventos de scroll e zoom no container
            container.addEventListener('touchmove', (e) => {
                if (isDragging) e.preventDefault();
            }, { passive: false });
        }

        function updateJoystickCommand(x, y, type) {
            // Aplicar filtro de suavização para evitar leituras erráticas
            const smoothX = smoothValue(type, 'x', x);
            const smoothY = smoothValue(type, 'y', y);
            
            // Atualizar apenas o joystick correspondente
            if (type === 'left') {
                leftJoystickData = { x: 0, y: smoothY };
            } else if (type === 'right') {
                rightJoystickData = { x: smoothX, y: 0 };
            } else {
                centerJoystickData = { x: smoothX, y: smoothY };
            }
            
            // Enviar comando com controle de taxa
            sendJoystickCommand();
        }

        function sendJoystickCommand(immediate = false) {
            const now = Date.now();
            
            // Controle de taxa - não enviar mais frequentemente que o intervalo definido
            if (!immediate && now - lastSendTime < SEND_INTERVAL) {
                return;
            }
            
            lastSendTime = now;
            
            // Determinar qual layout está ativo
            let x, y;
            
            if (document.querySelector('.landscape-layout').style.display !== 'none') {
                // Modo paisagem - usar joysticks separados
                x = rightJoystickData.x;
                y = leftJoystickData.y;
            } else {
                // Modo retrato ou desktop - usar joystick central
                x = centerJoystickData.x;
                y = centerJoystickData.y;
            }
            
            // Enviar comando
            fetch(`/joystick?x=${x}&y=${y}`)
                .then(response => response.text())
                .then(data => {
                    updateConnectionStatus(data);
                })
                .catch(error => {
                    console.error('Erro ao enviar comando de joystick:', error);
                    updateConnectionStatus('ERROR');
                });
        }

        // ===== OUTRAS FUNÇÕES =====
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            if (!statusElement) return;
            
            statusElement.classList.remove('error', 'blocked');
            
            switch(status) {
                case 'OK':
                    statusElement.textContent = 'Conectado';
                    statusElement.className = 'status';
                    isConnected = true;
                    break;
                case 'BLOCKED':
                    statusElement.textContent = 'Bloqueado - Use X';
                    statusElement.classList.add('blocked');
                    isConnected = false;
                    break;
                case 'ERROR':
                    statusElement.textContent = 'Erro de Conexão';
                    statusElement.classList.add('error');
                    isConnected = false;
                    break;
                default:
                    statusElement.textContent = status;
                    break;
            }
        }

        // ===== INICIALIZAÇÃO =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando controles...');
            
            // Configurar os joysticks
            setupJoysticks();
            setupButtonEvents();
            setupCameraStream();
            updateSpeedDisplay();
            
            // Event listeners de teclado
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            // Prevenir scroll e zoom em dispositivos móveis
            document.addEventListener('touchmove', function(e) {
                if (e.target.closest('.joystick-container') || e.target.closest('.control-btn')) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // Cleanup na mudança de orientação
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    leftJoystickData = { x: 0, y: 0 };
                    rightJoystickData = { x: 0, y: 0 };
                    centerJoystickData = { x: 0, y: 0 };
                    sendJoystickCommand();
                }, 500);
            });

            console.log('Controles inicializados com sucesso!');
        });
    </script>
</body>
</html>